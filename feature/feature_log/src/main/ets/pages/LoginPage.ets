import { BusinessError } from '@kit.BasicServicesKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { UserService } from 'lib_api';
import { RouterManager, RouterKey } from 'lib_router';
import auth, { SignInParam, SignInResult, TokenResult } from '@hw-agconnect/auth';
import { loginComponentManager } from '@kit.AccountKit';


const LOG_TAG: string = 'LoginPage';
const DOMAIN_ID: number = 0x0000;

@Component
export struct LoginPage {
  private userService: UserService = UserService.getInstance();
  private router: RouterManager = RouterManager.getInstance();
  @State isSelected: boolean = false;

  // åè®®å¼¹æ¡†
  agreementDialog: CustomDialogController = new CustomDialogController({
    builder: HuaweiAgreementDialog({
      cancel: () => {
        this.agreementDialog.close();
      },
      confirm: () => {
        this.agreementDialog.close();
        this.isSelected = true;
        // åŒæ„åè®®åŽç›´æŽ¥æ‰§è¡Œç™»å½•
        this.doHuaweiSignIn();
      }
    }),
    autoCancel: false,
    alignment: DialogAlignment.Center,
  });

  /**
   * åŽä¸ºè´¦å·ç™»å½•å…¥å£ - ç‚¹å‡»æŒ‰é’®æ—¶è°ƒç”¨
   */
  private onLoginClick(): void {
    if (!this.isSelected) {
      // æœªå‹¾é€‰åè®®ï¼Œå¼¹å‡ºåè®®å¼¹æ¡†
      this.agreementDialog.open();
      return;
    }
    this.doHuaweiSignIn();
  }

  /**
   * ä½¿ç”¨ AGC è®¤è¯æœåŠ¡ç›´æŽ¥ç™»å½•åŽä¸ºè´¦å·
   * æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹ï¼šauth.signIn({ credentialInfo: { kind: 'hwid' }, autoCreateUser: true })
   * AGC SDK ä¼šè‡ªåŠ¨æ‹‰èµ·åŽä¸ºè´¦å·æŽˆæƒç•Œé¢
   */
  private doHuaweiSignIn(): void {
    if (this.userService.isLoggedIn()) {
      return;
    }
    hilog.info(DOMAIN_ID, LOG_TAG, '[DEBUG] doHuaweiSignIn - å¼€å§‹ AGC åŽä¸ºè´¦å·ç™»å½•...');
    this.userService.login()
  }

  build() {
    NavDestination() {
      Column() {
        // é¡¶éƒ¨è¿”å›žæŒ‰é’®
        Row() {
          Button({ type: ButtonType.Normal }) {
            Text('â†').fontSize(20).fontColor($r('app.color.text_black'))
          }
          .width(40).height(40).borderRadius(20)
          .backgroundColor($r('app.color.page_background'))
          .onClick(() => { this.router.pop(); })
          Blank()
        }.width('100%').padding({ left: 16, right: 16, top: 12 })

        Scroll() {
          Column() {
            // Logo åŒºåŸŸ
            Column({ space: 8 }) {
              Text($r('app.string.app_name'))
                .fontSize(32).fontWeight(FontWeight.Bold).fontColor($r('app.color.primary_blue'))
              Text($r('app.string.login_subtitle'))
                .fontSize(14).fontColor($r('app.color.text_gray'))
            }.margin({ top: 60, bottom: 48 })

            // åŽä¸ºè´¦å·ç™»å½•
            Column({ space: 16 }) {
              // åŒæ­¥æç¤º
              Row({ space: 6 }) {
                Text('ðŸ”„').fontSize(14)
                Text($r('app.string.sync_login_hint'))
                  .fontSize(12).fontColor($r('app.color.text_gray'))
              }.width('85%')

              // åŽä¸ºè´¦å·ç™»å½•æŒ‰é’®ï¼ˆç›´æŽ¥è°ƒç”¨ AGC Auth signInï¼‰
              Button($r('app.string.huawei_login_btn'))
                .width('85%')
                .height(40)
                .borderRadius(24)
                .backgroundColor('#CE0E2D')
                .fontColor(Color.White)
                .fontSize(16)
                .enabled(!this.userService.isLoggedIn())
                .onClick(() => {
                  this.onLoginClick();
                })

              // åè®®å‹¾é€‰
              Row() {
                Checkbox({ name: 'agreementCheckbox', group: 'agreementGroup' })
                  .width(20).height(20)
                  .select(this.isSelected)
                  .selectedColor($r('app.color.primary_blue'))
                  .onChange((value: boolean) => {
                    this.isSelected = value;
                  })

                Text() {
                  Span($r('app.string.agree_text'))
                    .fontSize(11).fontColor($r('app.color.text_gray'))
                  Span($r('app.string.user_agreement'))
                    .fontSize(11).fontColor($r('app.color.primary_blue'))
                  Span($r('app.string.and_text'))
                    .fontSize(11).fontColor($r('app.color.text_gray'))
                  Span($r('app.string.privacy_policy'))
                    .fontSize(11).fontColor($r('app.color.primary_blue'))
                }
                .margin({ left: 8 })
              }
              .width('85%')
              .alignItems(VerticalAlign.Top)
            }
          }.width('100%').padding({ bottom: 30 })
        }.layoutWeight(1)
      }.width('100%').height('100%').backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
  }
}

@CustomDialog
struct HuaweiAgreementDialog {
  dialogController?: CustomDialogController;
  cancel: () => void = () => {};
  confirm: () => void = () => {};

  build() {
    Column() {
      Row() {
        Text($r('app.string.agreement_dialog_title'))
          .fontSize(18).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_black'))
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 24, bottom: 16 })

      Row() {
        Text() {
          Span($r('app.string.agree_text'))
            .fontSize(14).fontColor($r('app.color.text_gray'))
          Span($r('app.string.user_agreement'))
            .fontSize(14).fontColor($r('app.color.primary_blue'))
          Span($r('app.string.and_text'))
            .fontSize(14).fontColor($r('app.color.text_gray'))
          Span($r('app.string.privacy_policy'))
            .fontSize(14).fontColor($r('app.color.primary_blue'))
        }
      }
      .width('100%')
      .padding({ left: 24, right: 24 })

      Row({ space: 16 }) {
        Button($r('app.string.cancel_text'))
          .layoutWeight(1).height(40)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_gray'))
          .onClick(() => { this.cancel(); })

        Button($r('app.string.agree_and_login'))
          .layoutWeight(1).height(40)
          .backgroundColor($r('app.color.primary_blue'))
          .fontColor(Color.White)
          .onClick(() => { this.confirm(); })
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 16, bottom: 24 })
    }
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}
