
import { Course, TrainingPlan } from 'lib_entity';
import { FitnessService, UserService } from 'lib_api';
import { RouterManager, RouterKey } from 'lib_router';
import { StorageKey } from 'appscopecommon';
import { SportParam } from 'feature_sport';
import { VideoParam } from 'feature_video';
import promptAction from '@ohos.promptAction';
import { hilog } from '@kit.PerformanceAnalysisKit';

const HOME_TAG: string = 'HomePage';
const HOME_DOMAIN: number = 0x0000;


@Component
export struct Home {
  private service: FitnessService = FitnessService.getInstance();
  private userService: UserService = UserService.getInstance();
  private router: RouterManager = RouterManager.getInstance();
  @State featuredCourses: Course[] = [];
  @State activePlan: TrainingPlan | null = null;
  @State isLoggedIn: boolean = false;
  @State userName: string = '';
  @State todayStats: number[] = [0, 0, 0]; // [count, duration, calories]
  @State consecutiveDays: number = 0;
  @State isTodayCheckedIn: boolean = false;
  @StorageProp(StorageKey.USER_LOGIN_STATE) @Watch('onLoginStateChange') loginState: number = 0;
  @StorageProp(StorageKey.LAST_CHECK_IN_DATE) @Watch('onPersistedCheckInChange') persistedCheckInDate: string = '';

  aboutToAppear() {
    this.refreshData();
  }

  onLoginStateChange(): void {
    this.refreshData();
  }

  onPersistedCheckInChange(): void {
    let today = this.userService.getTodayString();
    this.isTodayCheckedIn = this.persistedCheckInDate === today;
    hilog.info(HOME_DOMAIN, HOME_TAG, 'onPersistedCheckInChange - persistedDate: %{public}s, today: %{public}s, isTodayCheckedIn: %{public}s',
      this.persistedCheckInDate, today, this.isTodayCheckedIn.toString());
  }

  refreshData(): void {
    hilog.info(HOME_DOMAIN, HOME_TAG, 'refreshData - åˆ·æ–°é¦–é¡µæ•°æ®');
    this.featuredCourses = this.service.getAllCourses();
    this.activePlan = this.service.getActivePlan();
    this.todayStats = this.service.getTodayStats();
    hilog.info(HOME_DOMAIN, HOME_TAG, 'ä»Šæ—¥ç»Ÿè®¡: æ¬¡æ•°=%{public}d, æ—¶é•¿=%{public}d, å¡è·¯é‡Œ=%{public}d',
      this.todayStats[0], this.todayStats[1], this.todayStats[2]);
    let currentUser = this.userService.getCurrentUser();
    if (currentUser !== null) {
      this.isLoggedIn = currentUser.isLoggedIn;
      this.userName = currentUser.username;
      this.consecutiveDays = currentUser.consecutiveDays;
    } else {
      this.isLoggedIn = false;
    }
    // ç›´æŽ¥ä»ŽæŒä¹…åŒ–å­˜å‚¨è¯»å–æ‰“å¡çŠ¶æ€ï¼Œä¸ä¾èµ– currentUser å†…å­˜çŠ¶æ€
    let today = this.userService.getTodayString();
    this.isTodayCheckedIn = this.persistedCheckInDate === today;
  }

  build() {
    Scroll() {
      Column({ space: 15 }) {
        // é¡¶éƒ¨: Appå + ç™»å½•/ç”¨æˆ·å
        Row() {
          Text($r('app.string.app_name'))
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)

          if (this.isLoggedIn) {
            Row({ space: 6 }) {
              Circle({ width: 28, height: 28 }).fill($r('app.color.primary_blue'))
              Text(this.userName).fontSize(14).fontColor($r('app.color.primary_blue'))
            }
          } else {
            Button($r('app.string.login_text'))
              .fontSize(14)
              .height(32)
              .onClick(() => {
                this.router.push(RouterKey.LOGIN);
              })
          }
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20 })

        // Banner: ç›®æ ‡è®¾å®š / ä»Šæ—¥æ¦‚è§ˆ
        Column({ space: 8 }) {
          if (this.isLoggedIn) {
            // ç™»å½•åŽ: ä»Šæ—¥æ¦‚è§ˆ
            Text($r('app.string.today_overview'))
              .fontColor($r('app.color.text_white')).fontSize(18).fontWeight(FontWeight.Bold)
            Row() {
              Column() {
                Text(this.todayStats[0].toString())
                  .fontSize(20).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
                Text($r('app.string.stat_workouts'))
                  .fontSize(11).fontColor($r('app.color.plan_text_secondary'))
              }.layoutWeight(1)
              Column() {
                Text(this.todayStats[1].toString())
                  .fontSize(20).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
                Text($r('app.string.stat_minutes'))
                  .fontSize(11).fontColor($r('app.color.plan_text_secondary'))
              }.layoutWeight(1)
              Column() {
                Text(this.todayStats[2].toString())
                  .fontSize(20).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
                Text($r('app.string.stat_kcal'))
                  .fontSize(11).fontColor($r('app.color.plan_text_secondary'))
              }.layoutWeight(1)
            }.width('100%')
            // è¿žç»­æ‰“å¡
            if (this.consecutiveDays > 0) {
              Row() {
                Text('ðŸ”¥').fontSize(14)
                Text(' ' + this.consecutiveDays.toString())
                  .fontSize(12).fontColor($r('app.color.text_white'))
                Text($r('app.string.consecutive_days_suffix'))
                  .fontSize(12).fontColor($r('app.color.text_white'))
              }
            }
            if (!this.isTodayCheckedIn) {
              Button($r('app.string.check_in_btn'))
                .fontSize(12)
                .height(28)
                .margin({ top: 8 })
                .onClick(() => {
                  hilog.info(HOME_DOMAIN, HOME_TAG, 'é¦–é¡µä»Šæ—¥æ‰“å¡ - å¼€å§‹æ‰§è¡Œ');
                  this.userService.checkIn();
                  // ç›´æŽ¥æ›´æ–° @State é©±åŠ¨ UI ç«‹å³åˆ·æ–°
                  this.isTodayCheckedIn = true;
                  let currentUser = this.userService.getCurrentUser();
                  if (currentUser !== null) {
                    this.consecutiveDays = currentUser.consecutiveDays;
                  }
                  hilog.info(HOME_DOMAIN, HOME_TAG, 'é¦–é¡µä»Šæ—¥æ‰“å¡ - æ‰“å¡å®Œæˆ, isTodayCheckedIn=%{public}s, consecutiveDays=%{public}d',
                    this.isTodayCheckedIn.toString(), this.consecutiveDays);
                  promptAction.showToast({ message: getContext(this).resourceManager.getStringSync($r('app.string.check_in_success')) });
                })
            } else {
              Row() {
                Text('âœ…').fontSize(12)
                Text($r('app.string.already_checked_in'))
                  .fontSize(11).fontColor($r('app.color.text_white')).margin({ left: 6 })
              }.margin({ top: 8 })
            }
          } else {
            // æœªç™»å½•: æ¬¢è¿Ž Bannerï¼ˆæœ¬åœ°æ¨¡å¼ï¼Œæ— éœ€ç™»å½•ä¹Ÿå¯ä½¿ç”¨ï¼‰
            Text($r('app.string.banner_title'))
              .fontColor($r('app.color.text_white'))
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
            Text($r('app.string.local_mode_hint'))
              .fontColor($r('app.color.plan_text_secondary'))
              .fontSize(12).margin({ top: 6 })
          }
        }
        .width('90%')
        .padding(20)
        .backgroundColor($r('app.color.banner_bg'))
        .borderRadius(16)
        .alignItems(HorizontalAlign.Start)

        // å¿«æ·æ“ä½œåŒºï¼ˆæ— è®ºæ˜¯å¦ç™»å½•å‡å¯ä½¿ç”¨ï¼‰
        Row() {
          Column({ space: 4 }) {
            Text('ðŸ“‹').fontSize(24)
            Text($r('app.string.quick_plan')).fontSize(11).fontColor($r('app.color.text_gray'))
          }.layoutWeight(1).onClick(() => { this.router.push(RouterKey.TRAINING_PLAN_LIST); })
          Column({ space: 4 }) {
            Text('âœï¸').fontSize(24)
            Text($r('app.string.quick_record')).fontSize(11).fontColor($r('app.color.text_gray'))
          }.layoutWeight(1).onClick(() => { this.router.push(RouterKey.MANUAL_RECORD); })
          Column({ space: 4 }) {
            Text('ðŸ…').fontSize(24)
            Text($r('app.string.quick_badge')).fontSize(11).fontColor($r('app.color.text_gray'))
          }.layoutWeight(1).onClick(() => { this.router.push(RouterKey.BADGE_GALLERY); })
          Column({ space: 4 }) {
            Text('ðŸ“Š').fontSize(24)
            Text($r('app.string.quick_history')).fontSize(11).fontColor($r('app.color.text_gray'))
          }.layoutWeight(1).onClick(() => { this.router.push(RouterKey.EXERCISE_HISTORY); })
        }.width('90%').padding(12).backgroundColor(Color.White).borderRadius(12)
        .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

        // æœªç™»å½•æ—¶æ˜¾ç¤ºåŒæ­¥æç¤º
        if (!this.isLoggedIn) {
          Row({ space: 6 }) {
            Text('ðŸ”„').fontSize(13)
            Text($r('app.string.sync_login_hint'))
              .fontSize(12).fontColor($r('app.color.text_gray')).layoutWeight(1)
            Text($r('app.string.login_text'))
              .fontSize(12).fontColor($r('app.color.primary_blue'))
              .onClick(() => { this.router.push(RouterKey.LOGIN); })
          }
          .width('90%').padding(10).backgroundColor(Color.White).borderRadius(10)
        }

        // è¿›è¡Œä¸­çš„è®¡åˆ’
        if (this.activePlan !== null) {
          Column({ space: 6 }) {
            Row() {
              Text($r('app.string.active_plan_title'))
                .fontSize(16).fontWeight(FontWeight.Bold).layoutWeight(1)
              Text($r('app.string.view_all_plans')).fontSize(12).fontColor($r('app.color.primary_blue'))
                .onClick(() => { this.router.push(RouterKey.TRAINING_PLAN_LIST); })
            }.width('100%')
            Column({ space: 6 }) {
              Text(this.activePlan.name)
                .fontSize(16).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
              Row() {
                Text($r('app.string.progress_label')).fontSize(12).fontColor($r('app.color.plan_text_secondary'))
                Blank()
                Text(this.activePlan.completedDays.toString() + '/' + this.activePlan.durationDays.toString())
                  .fontSize(12).fontColor($r('app.color.text_white'))
                Text($r('app.string.unit_day'))
                  .fontSize(12).fontColor($r('app.color.text_white'))
              }.width('100%')
              Progress({ value: this.activePlan.progress, total: 100, type: ProgressType.Linear })
                .width('100%').color($r('app.color.text_white'))
            }.padding(12).backgroundColor($r('app.color.plan_ongoing_bg')).borderRadius(12)
          }.width('90%').padding(8)
        }

        // æŽ¨èè¯¾ç¨‹
        Text($r('app.string.recommendations_title'))
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 20 })
          .width('100%')

        List({ space: 10 }) {
          ForEach(this.featuredCourses, (item: Course) => {
            ListItem() {
              Row() {
                Column()
                  .width(60)
                  .height(60)
                  .backgroundColor($r('app.color.placeholder_bg'))
                  .borderRadius(8)

                Column({ space: 4 }) {
                  Text(item.title)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)

                  Row({ space: 6 }) {
                    Text(item.duration.toString())
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text($r('app.string.unit_min'))
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text(item.calories.toString())
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text($r('app.string.unit_kcal'))
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                  }

                  if (item.category.length > 0) {
                    Text(item.category)
                      .fontSize(10).fontColor($r('app.color.primary_blue'))
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .borderRadius(4).backgroundColor($r('app.color.status_ongoing_bg'))
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 10 })

                Column({ space: 4 }) {
                  Button($r('app.string.watch_video_btn'))
                    .fontSize(12)
                    .height(28)
                    .backgroundColor(Color.White)
                    .fontColor($r('app.color.primary_blue'))
                    .border({ width: 1, color: $r('app.color.primary_blue') })
                    .onClick(() => {
                      let videoParam: VideoParam = new VideoParam(item.title, item.videoUrl, item.id);
                      this.router.push(RouterKey.VIDEO_PLAYER, videoParam);
                    })
                  Button($r('app.string.start_button'))
                    .fontSize(12)
                    .height(28)
                    .onClick(() => {
                      hilog.info(HOME_DOMAIN, HOME_TAG, 'é¦–é¡µå¼€å§‹è®­ç»ƒ - courseId: %{public}d, title: %{public}s', item.id, item.title);
                      let param: SportParam = new SportParam(item.id, item.title, item.duration, item.calories, item.videoUrl);
                      this.router.push(RouterKey.ACTIVE_TRAINING, param);
                    })
                }
              }
              .padding(10)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .width('100%')
            }
          })
        }
        .width('90%')
      }
      .width('100%')
      .padding({ bottom: 20 })
    }
    .align(Alignment.Top)
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .onAppear(() => { this.refreshData(); })
  }
}


