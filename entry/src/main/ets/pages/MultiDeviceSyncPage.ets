
import { VideoSyncService, UserService } from 'lib_api';
import { VideoPlayProgress } from 'lib_entity';
import { RouterManager } from 'lib_router';
import { hilog } from '@kit.PerformanceAnalysisKit';

const SYNC_TAG: string = 'MultiDeviceSyncPage';

@Component
export struct MultiDeviceSyncPage {
  private router: RouterManager = RouterManager.getInstance();
  private syncService: VideoSyncService = VideoSyncService.getInstance();
  private userService: UserService = UserService.getInstance();

  @State isServiceReady: boolean = false;
  @State syncedProgressList: VideoPlayProgress[] = [];
  @State isLoading: boolean = false;
  @State statusMessage: string = '';
  @State isLoggedIn: boolean = false;
  @State showSimulatePanel: boolean = false;
  @State simulateStatus: string = '';

  aboutToAppear(): void {
    this.isServiceReady = this.syncService.isReady();
    this.isLoggedIn = this.userService.isLoggedIn();
    this.loadAllProgress();
  }

  // åŠ è½½æ‰€æœ‰å·²åŒæ­¥çš„è¿›åº¦æ•°æ®
  private loadAllProgress(): void {
    this.isLoading = true;
    this.syncService.getAllProgress().then((list: VideoPlayProgress[]) => {
      this.syncedProgressList = list;
      this.isLoading = false;
      hilog.info(0x0000, SYNC_TAG, 'Loaded %{public}d synced progress entries', list.length);
    });
  }

  // æ‰‹åŠ¨è§¦å‘åŒæ­¥
  private triggerSync(): void {
    this.statusMessage = 'æ­£åœ¨åŒæ­¥...';
    this.syncService.syncData().then((success: boolean) => {
      if (success) {
        this.statusMessage = 'åŒæ­¥è¯·æ±‚å·²å‘é€';
        // åˆ·æ–°åˆ—è¡¨
        this.loadAllProgress();
      } else {
        this.statusMessage = 'åŒæ­¥è¯·æ±‚å¤±è´¥ï¼ˆæ¨¡æ‹Ÿå™¨ä¸æ”¯æŒåˆ†å¸ƒå¼åŒæ­¥ï¼Œè¯·ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼‰';
      }
    });
  }

  // è¿è¡Œæ¨¡æ‹ŸåŒæ­¥æ¼”ç¤º
  private runSimulateDemo(): void {
    this.simulateStatus = 'æ­£åœ¨æ¨¡æ‹Ÿè¿œç«¯è®¾å¤‡å†™å…¥æ•°æ®...';

    // æ¨¡æ‹Ÿ3æ¡æ¥è‡ªä¸åŒè®¾å¤‡çš„åŒæ­¥æ•°æ®
    let promise1 = this.syncService.simulateRemoteSync(101, 'å…¨èº«ç‡ƒè„‚HIITè®­ç»ƒ', 185, 600);
    let promise2 = this.syncService.simulateRemoteSync(102, 'æ ¸å¿ƒåŠ›é‡å¼ºåŒ–', 420, 900);
    let promise3 = this.syncService.simulateRemoteSync(103, 'æ™¨é—´æ‹‰ä¼¸æ”¾æ¾', 90, 300);

    Promise.all([promise1, promise2, promise3]).then((results: boolean[]) => {
      let successCount: number = 0;
      for (let i = 0; i < results.length; i++) {
        if (results[i]) {
          successCount++;
        }
      }
      this.simulateStatus = 'æ¨¡æ‹Ÿå®Œæˆï¼šæˆåŠŸå†™å…¥ ' + successCount.toString() + ' æ¡è¿œç«¯åŒæ­¥æ•°æ®';
      hilog.info(0x0000, SYNC_TAG, 'Simulate demo completed, success: %{public}d', successCount);
      // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæ–°å†™å…¥çš„æ•°æ®
      this.loadAllProgress();
    });
  }

  // æ¸…ç©ºæ‰€æœ‰åŒæ­¥æ•°æ®
  private clearAllData(): void {
    this.syncService.clearAllProgress().then((success: boolean) => {
      if (success) {
        this.statusMessage = 'å·²æ¸…ç©ºæ‰€æœ‰åŒæ­¥æ•°æ®';
        this.syncedProgressList = [];
        this.simulateStatus = '';
      }
    });
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(seconds: number): string {
    let mins: number = Math.floor(seconds / 60);
    let secs: number = Math.floor(seconds % 60);
    let minStr: string = mins < 10 ? '0' + mins.toString() : mins.toString();
    let secStr: string = secs < 10 ? '0' + secs.toString() : secs.toString();
    return minStr + ':' + secStr;
  }

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  private formatTimestamp(ts: number): string {
    if (ts <= 0) {
      return 'æœªçŸ¥';
    }
    let date: Date = new Date(ts);
    let month: string = (date.getMonth() + 1).toString();
    let day: string = date.getDate().toString();
    let hour: string = date.getHours() < 10 ? '0' + date.getHours().toString() : date.getHours().toString();
    let minute: string = date.getMinutes() < 10 ? '0' + date.getMinutes().toString() : date.getMinutes().toString();
    return month + 'æœˆ' + day + 'æ—¥ ' + hour + ':' + minute;
  }

  build() {
    NavDestination() {
      Column() {
        // ========== é¡¶éƒ¨å¯¼èˆªæ  ==========
        Row() {
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .onClick(() => { this.router.pop(); })
            .padding({ right: 12 })
          Text('å¤šç«¯æ•°æ®åŒæ­¥')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 12 })

        Scroll() {
          Column({ space: 16 }) {

            // ========== åŒæ­¥æœåŠ¡çŠ¶æ€å¡ç‰‡ ==========
            Column({ space: 12 }) {
              Row({ space: 8 }) {
                Text(this.isServiceReady ? 'ğŸŸ¢' : 'ğŸ”´').fontSize(16)
                Text('åˆ†å¸ƒå¼åŒæ­¥æœåŠ¡')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                Blank()
                Text(this.isServiceReady ? 'å·²å°±ç»ª' : 'æœªåˆå§‹åŒ–')
                  .fontSize(13)
                  .fontColor(this.isServiceReady ? '#4CAF50' : '#F44336')
              }.width('100%')

              Row({ space: 8 }) {
                Text(this.isLoggedIn ? 'ğŸŸ¢' : 'ğŸŸ¡').fontSize(16)
                Text('åä¸ºè´¦å·')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                Blank()
                Text(this.isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•')
                  .fontSize(13)
                  .fontColor(this.isLoggedIn ? '#4CAF50' : '#FF9800')
              }.width('100%')

              // åŒæ­¥åŸç†è¯´æ˜
              Column({ space: 6 }) {
                Text('åŒæ­¥åŸç†')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.primary_blue'))
                Text('åŸºäº HarmonyOS åˆ†å¸ƒå¼ KV Storeï¼ˆé”®å€¼æ•°æ®åº“ï¼‰å®ç°ã€‚å½“å¤šå°é¸¿è’™è®¾å¤‡ç™»å½•åŒä¸€åä¸ºè´¦å·å¹¶å¤„äºåŒä¸€å±€åŸŸç½‘æ—¶ï¼ŒKV Store ä¸­çš„æ•°æ®ä¼šé€šè¿‡åˆ†å¸ƒå¼è½¯æ€»çº¿è‡ªåŠ¨åŒæ­¥ã€‚')
                  .fontSize(12)
                  .fontColor($r('app.color.text_gray'))
                  .lineHeight(18)
                Text('é…ç½®ï¼šautoSync=true | å®‰å…¨çº§åˆ«=S1 | ç±»å‹=SINGLE_VERSION')
                  .fontSize(11)
                  .fontColor($r('app.color.text_light_gray'))
                  .margin({ top: 4 })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)

            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

            // ========== æ“ä½œæŒ‰é’®åŒºåŸŸ ==========
            Column({ space: 10 }) {
              Text('åŒæ­¥æ“ä½œ')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')

              Row({ space: 10 }) {
                Button('æ‰‹åŠ¨åŒæ­¥')
                  .layoutWeight(1)
                  .height(40)
                  .fontSize(14)
                  .backgroundColor($r('app.color.primary_blue'))
                  .onClick(() => { this.triggerSync(); })

                Button('åˆ·æ–°æ•°æ®')
                  .layoutWeight(1)
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#4CAF50')
                  .onClick(() => {
                    this.statusMessage = 'æ­£åœ¨åˆ·æ–°...';
                    this.loadAllProgress();
                    this.statusMessage = 'æ•°æ®å·²åˆ·æ–°';
                  })

                Button('æ¸…ç©ºæ•°æ®')
                  .layoutWeight(1)
                  .height(40)
                  .fontSize(14)
                  .backgroundColor('#F44336')
                  .onClick(() => { this.clearAllData(); })
              }.width('100%')

              if (this.statusMessage.length > 0) {
                Text(this.statusMessage)
                  .fontSize(13)
                  .fontColor($r('app.color.primary_blue'))
                  .width('100%')
                  .textAlign(TextAlign.Center)
                  .margin({ top: 4 })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

            // ========== æ¨¡æ‹ŸåŒæ­¥æ¼”ç¤ºï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ ==========
            Column({ space: 12 }) {
              Row() {
                Column({ space: 4 }) {
                  Text('ğŸ“± æ¨¡æ‹ŸåŒæ­¥æ¼”ç¤º')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                  Text('æ¨¡æ‹Ÿå™¨ä¸æ”¯æŒåˆ†å¸ƒå¼è½¯æ€»çº¿ï¼Œå¯é€šè¿‡æ­¤åŠŸèƒ½æ¼”ç¤ºå®Œæ•´åŒæ­¥æµç¨‹')
                    .fontSize(12)
                    .fontColor($r('app.color.text_gray'))
                }.layoutWeight(1).alignItems(HorizontalAlign.Start)
                Toggle({ type: ToggleType.Switch, isOn: this.showSimulatePanel })
                  .onChange((isOn: boolean) => { this.showSimulatePanel = isOn; })
              }.width('100%')

              if (this.showSimulatePanel) {
                Column({ space: 10 }) {
                  // æ¼”ç¤ºè¯´æ˜
                  Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†æ¨¡æ‹Ÿå¦ä¸€å°è®¾å¤‡ï¼ˆHUAWEI MatePadï¼‰å‘ KV Store å†™å…¥ 3 æ¡è§†é¢‘æ’­æ”¾è¿›åº¦æ•°æ®ã€‚å†™å…¥ååœ¨è§†é¢‘æ’­æ”¾é¡µå³å¯çœ‹åˆ°"å‘ç°è·¨è®¾å¤‡åŒæ­¥è¿›åº¦"çš„æ¢å¤æç¤ºã€‚')
                    .fontSize(12)
                    .fontColor($r('app.color.text_gray'))
                    .lineHeight(18)

                  // æ¨¡æ‹Ÿæ•°æ®é¢„è§ˆ
                  Column({ space: 6 }) {
                    Text('å°†å†™å…¥çš„æ¨¡æ‹Ÿæ•°æ®ï¼š')
                      .fontSize(13)
                      .fontWeight(FontWeight.Bold)
                    this.SimulateDataPreview('å…¨èº«ç‡ƒè„‚HIITè®­ç»ƒ', 185, 600, 101)
                    this.SimulateDataPreview('æ ¸å¿ƒåŠ›é‡å¼ºåŒ–', 420, 900, 102)
                    this.SimulateDataPreview('æ™¨é—´æ‹‰ä¼¸æ”¾æ¾', 90, 300, 103)
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#FFF8E1')
                  .borderRadius(8)

                  Button('ğŸš€ æ‰§è¡Œæ¨¡æ‹ŸåŒæ­¥')
                    .width('100%')
                    .height(44)
                    .fontSize(15)
                    .fontWeight(FontWeight.Bold)
                    .backgroundColor('#FF9800')
                    .onClick(() => { this.runSimulateDemo(); })

                  if (this.simulateStatus.length > 0) {
                    Row({ space: 6 }) {
                      Text('âœ…').fontSize(14)
                      Text(this.simulateStatus)
                        .fontSize(13)
                        .fontColor('#4CAF50')
                        .fontWeight(FontWeight.Bold)
                    }
                    .width('100%')
                    .padding(10)
                    .backgroundColor('#E8F5E9')
                    .borderRadius(8)
                  }

                  // éªŒè¯æç¤º
                  Column({ space: 4 }) {
                    Text('å¦‚ä½•éªŒè¯åŒæ­¥æ•ˆæœï¼š')
                      .fontSize(13)
                      .fontWeight(FontWeight.Bold)
                      .fontColor($r('app.color.primary_blue'))
                    Text('1. æ‰§è¡Œæ¨¡æ‹ŸåŒæ­¥åï¼Œä¸‹æ–¹"å·²åŒæ­¥æ•°æ®åˆ—è¡¨"å°†æ˜¾ç¤ºå†™å…¥çš„æ•°æ®')
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text('2. è¿”å›è¯¾ç¨‹åˆ—è¡¨ï¼Œæ‰“å¼€å¯¹åº”è¯¾ç¨‹çš„è§†é¢‘æ’­æ”¾')
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text('3. è§†é¢‘æ’­æ”¾é¡µä¼šå¼¹å‡º"å‘ç°è·¨è®¾å¤‡åŒæ­¥è¿›åº¦"æç¤º')
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                    Text('4. ç‚¹å‡»"ç»§ç»­æ’­æ”¾"å¯è·³è½¬åˆ°æ¨¡æ‹Ÿçš„è¿œç«¯æ’­æ”¾ä½ç½®')
                      .fontSize(12).fontColor($r('app.color.text_gray'))
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#E3F2FD')
                  .borderRadius(8)
                  .alignItems(HorizontalAlign.Start)
                }.width('100%')
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

            // ========== å·²åŒæ­¥æ•°æ®åˆ—è¡¨ ==========
            Column({ space: 10 }) {
              Row() {
                Text('å·²åŒæ­¥æ•°æ®åˆ—è¡¨')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                Blank()
                Text(this.syncedProgressList.length.toString() + ' æ¡è®°å½•')
                  .fontSize(13)
                  .fontColor($r('app.color.text_gray'))
              }.width('100%')

              if (this.isLoading) {
                Text('åŠ è½½ä¸­...')
                  .fontSize(14)
                  .fontColor($r('app.color.text_gray'))
                  .width('100%')
                  .textAlign(TextAlign.Center)
                  .padding(20)
              } else if (this.syncedProgressList.length === 0) {
                Column({ space: 8 }) {
                  Text('ğŸ“­').fontSize(40)
                  Text('æš‚æ— åŒæ­¥æ•°æ®')
                    .fontSize(14)
                    .fontColor($r('app.color.text_gray'))
                  Text('å¯é€šè¿‡"æ¨¡æ‹ŸåŒæ­¥æ¼”ç¤º"åŠŸèƒ½ç”Ÿæˆæµ‹è¯•æ•°æ®')
                    .fontSize(12)
                    .fontColor($r('app.color.text_light_gray'))
                }
                .width('100%')
                .padding(30)
                .justifyContent(FlexAlign.Center)
              } else {
                ForEach(this.syncedProgressList, (item: VideoPlayProgress) => {
                  Row() {
                    Column({ space: 4 }) {
                      // è§†é¢‘æ ‡é¢˜
                      Text(item.title)
                        .fontSize(15)
                        .fontWeight(FontWeight.Bold)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                      // æ’­æ”¾è¿›åº¦
                      Row({ space: 4 }) {
                        Text('è¿›åº¦ï¼š').fontSize(12).fontColor($r('app.color.text_gray'))
                        Text(this.formatTime(item.currentPosition) + ' / ' + this.formatTime(item.totalDuration))
                          .fontSize(12).fontColor($r('app.color.primary_blue')).fontWeight(FontWeight.Bold)
                        Text('(' + item.getProgressPercent().toString() + '%)')
                          .fontSize(12).fontColor($r('app.color.text_gray'))
                      }
                      // è¿›åº¦æ¡
                      Progress({ value: item.getProgressPercent(), total: 100, type: ProgressType.Linear })
                        .width('100%')
                        .height(4)
                        .color($r('app.color.primary_blue'))
                        .backgroundColor('#E0E0E0')
                      // æ¥æºè®¾å¤‡ä¸æ—¶é—´
                      Row({ space: 4 }) {
                        Text('ğŸ“±').fontSize(10)
                        Text(item.deviceInfo.length > 0 ? item.deviceInfo : 'æœªçŸ¥è®¾å¤‡')
                          .fontSize(11).fontColor($r('app.color.text_light_gray'))
                        Text(' Â· ').fontSize(11).fontColor($r('app.color.text_light_gray'))
                        Text(this.formatTimestamp(item.lastUpdated))
                          .fontSize(11).fontColor($r('app.color.text_light_gray'))
                      }
                    }.layoutWeight(1).alignItems(HorizontalAlign.Start)
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#FAFAFA')
                  .borderRadius(8)
                  .border({ width: 1, color: '#EEEEEE' })
                })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

            // ========== æŠ€æœ¯æ¶æ„è¯´æ˜ ==========
            Column({ space: 10 }) {
              Text('æŠ€æœ¯æ¶æ„')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')

              Column({ space: 6 }) {
                this.ArchItem('æ•°æ®å­˜å‚¨', 'distributedKVStore.SingleKVStoreï¼ˆåˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼‰')
                this.ArchItem('åŒæ­¥æ¨¡å¼', 'autoSync=trueï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰ + æ‰‹åŠ¨ PUSH_PULL åŒæ­¥')
                this.ArchItem('æ•°æ®æ ¼å¼', 'VideoPlayProgress JSON åºåˆ—åŒ–å­˜å‚¨')
                this.ArchItem('ç›‘å¬æœºåˆ¶', 'SUBSCRIBE_TYPE_REMOTE è¿œç¨‹æ•°æ®å˜æ›´å›è°ƒ')
                this.ArchItem('å®‰å…¨çº§åˆ«', 'SecurityLevel.S1ï¼ˆä½å®‰å…¨çº§åˆ«ï¼Œé€‚åˆéæ•æ„Ÿæ•°æ®ï¼‰')
                this.ArchItem('æƒé™è¦æ±‚', 'ohos.permission.DISTRIBUTED_DATASYNC')
                this.ArchItem('é€‚ç”¨åœºæ™¯', 'çœŸæœºå¤šè®¾å¤‡ç™»å½•åŒä¸€è´¦å·ã€åŒä¸€å±€åŸŸç½‘ç¯å¢ƒ')
              }.width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 4, color: $r('app.color.shadow_color_light'), offsetY: 2 })

          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 30 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
  }

  @Builder SimulateDataPreview(title: string, position: number, duration: number, id: number) {
    Row({ space: 8 }) {
      Text('ğŸ¬').fontSize(14)
      Column({ space: 2 }) {
        Text(title).fontSize(13).fontWeight(FontWeight.Bold)
        Text('è¯¾ç¨‹ID: ' + id.toString() + '  |  è¿›åº¦: ' + this.formatTime(position) + '/' + this.formatTime(duration))
          .fontSize(11).fontColor($r('app.color.text_gray'))
      }.layoutWeight(1).alignItems(HorizontalAlign.Start)
    }.width('100%')
  }

  @Builder ArchItem(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(13)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.primary_blue'))
        .width(80)
      Text(value)
        .fontSize(12)
        .fontColor($r('app.color.text_gray'))
        .layoutWeight(1)
    }.width('100%').padding({ top: 4, bottom: 4 })
  }
}
